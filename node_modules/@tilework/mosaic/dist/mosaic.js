const e=Symbol("Extensible"),t=Symbol("CacheIdentityKey");function n(e,t){const{implementation:n}=e;if("function"==typeof e)return e;if("function"==typeof n)return n;throw new Error(`No implementation found in plugin definition for member ${t}.`)}function r(e=(()=>{}),t,r){return(...o)=>t.reduce(((t,s)=>()=>{const c=n(s,e.name);return"object"==typeof e?c("function"==typeof t?t():t,r):c(o,t.bind(r),r)}),e)()}const o=["member-function","member-property","static-member","function","class"],s=["function","class"];const c=e=>Array.isArray(e)?e:[e],i=e=>e.sort((({position:e=100},{position:t=100})=>e-t)),u=e=>{const t=e.reduce(((e,t)=>(Object.entries(t).forEach((([t,n])=>{e[t]||(e[t]={}),Object.entries(n).forEach((([n,r])=>{!function(e,t){if(!o.includes(e))throw Error(`Unexpected handler type '${e}' for namespace '${t}', expected one of [${o.join(", ")}]`)}(n,t),s.includes(n)?((e,t,n,r)=>{e[t][n]||(e[t][n]=[]),c(r).forEach((r=>{e[t][n].push(r)}))})(e,t,n,r):((e,t,n,r)=>{e[t][n]||(e[t][n]={}),Object.entries(r).forEach((([r,o])=>{e[t][n][r]||(e[t][n][r]=[]),c(o).forEach((o=>{e[t][n][r].push(o)}))}))})(e,t,n,r)}))})),e)),{});return(e=>{for(const t in e)for(const n in e[t])if(s.includes(n))e[t][n]=i(e[t][n]);else for(const r in e[t][n])e[t][n][r]=i(e[t][n][r])})(t),t};function l(e,t){return i(e.reduce(((e,t)=>(-1===e.indexOf(t)&&e.push(t),e)),t))}var a=new class{constructor(){this.plugins=[]}exposePlugins(){(function(){try{if("undefined"!=typeof globalThis)return globalThis;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;if("undefined"!=typeof ServiceWorkerGlobalScope)return ServiceWorkerGlobalScope}catch{}return{}}()).plugins=this.plugins}addPlugins(e){const t=u(e);var n,r;this.plugins||(this.plugins={}),n=this.plugins,r=t,Object.entries(r).forEach((([e,t])=>{n[e]||(n[e]={}),Object.entries(t).forEach((([t,r])=>{if(Array.isArray(r))return n[e][t]||(n[e][t]=[]),void(n[e][t]=l(r,n[e][t]));n[e][t]||(n[e][t]={}),Object.entries(r).forEach((([r,o])=>{n[e][t][r]||(n[e][t][r]=[]),n[e][t][r]=l(o,n[e][t][r])}))}))})),this.exposePlugins()}setPlugins(e){this.plugins=u(e),this.exposePlugins()}},f=(e,t,n)=>e.reduce(((e,r)=>{const o=a.plugins&&a.plugins[r]&&a.plugins[r][t];if(n){const{value:t}=Object.getOwnPropertyDescriptor(o||{},n)||{};if(t)return e.concat(t)}else if(o)return e.concat(o);return e}),[]);function p(e){return(t,n,o)=>{const s=f(e,"function");return s.length?r(t,s,n)(...o):t.apply(n,o)}}function d(e,t){return function(e){const t=e[e.length-1];return a.plugins[t]&&a.plugins[t].class||[]}(t).reduce(((t,r)=>{const o=n(r,e.name)(t);if(Object.prototype.isPrototypeOf.call(t,o))throw new Error("Subclassing via `class` API is not allowed.\nConsider using other approach for this, e.g. plugins for members.");return o}),e)}function g(e){return e.prototype.__namespaces__}function h(e){return(t,r,o)=>{const s=d(class extends t{constructor(...e){return function(e,t){if(void 0!==e.__isConstructorCalled)return e;const r=g(Object.getPrototypeOf(e).constructor);return f(r,"member-property").forEach((t=>Object.entries(t).forEach((([t,r])=>{const o=e[t]||(()=>{}),s=r.reduce(((t,r)=>n(r,o.name)(t,e)),o);e[t]=s})))),e.__construct&&(e.__construct(...t),e.__isConstructorCalled=!0),e}(Reflect.construct(t,r,o),e)}},e);return Reflect.construct(s,r)}}function y(e,t){return(n,o,s)=>{const c=Reflect.get(n,o,s),i=f(t,"class"===e?"static-member":"member-function",o);if(!i.length)return c;const u=r(c,i,s);return"object"==typeof c?u():u}}var b=new class{constructor(){this.generated=[]}addPlugins(e){a.addPlugins(e.map((e=>e.default||e)))}setPlugins(e){a.setPlugins(e.map((e=>e.default||e)))}Extensible(n=class{}){if(n[e])return n;const{name:r}=n,{value:o=Symbol(`Cache Identity ${r}`)}=Object.getOwnPropertyDescriptor(n,t)||{};if(!this.generated[o]){const r=class extends n{constructor(...e){super(...e);const{__namespaces__:t}=Object.getPrototypeOf(this),n=(e=>y("instance",e))(t);return new Proxy(this,{get:n})}__construct(){}};r[e]=!0,this.generated[o]=r,Object.defineProperty(n,t,{value:o,writable:!1})}return this.generated[o]}middleware(e,t){try{!function(e,t){const n=Object.assign([],Reflect.get(e.prototype,"__namespaces__"));n.includes(t)||n.push(t),e.prototype.__namespaces__=n}(e,t);const n=g(e),r={get:y("class",n),apply:p(n),construct:h(n)};return new Proxy(e,r)}catch(n){return console.log(`Failed to apply middleware to: ${e} (${t}).`),console.log(n),e}}};export default b;
